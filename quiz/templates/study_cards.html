{% extends "base.html" %}
{% load static %}
{% block content %}

<style>
  .card {
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  border: none;

  .list-group-item {
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  transition: background-color 0.2s ease;
}

.list-group-item:hover {
  background-color: #e6f0ff;
}
.result-icon {
  margin-left: 8px;
  float: right;
}

#results-container .list-group-item {
  background: #f8f9fa;
}
}
#answers-list .list-group-item {
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  background-color: #ffffff;
  padding: 16px;
  transition: background-color 0.2s ease;
  border: none;
}

#answers-list .list-group-item:hover {
  background-color: #f0f8ff;
}

#answers-list strong {
  color: #0078D4;
}

#answers-list em {
  color: #888;
}
.badge {
  font-size: 0.85rem;
  padding: 6px 10px;
  border-radius: 6px;
}
#answers-list .explanation {
  background-color: #f0f2f5;
  border-left: 4px solid #0078D4;
  padding: 12px;
  margin-top: 8px;
  border-radius: 6px;
}

</style>

<div class="container-lg py-4">
  <div class="row justify-content-center mb-3">
    <div class="col col-md-8">
      <h2 id="category-title" class="mb-3 text-start text-primary fw-semibold">{{ category.name }}</h2>
    </div>
  </div>
  <div class="row justify-content-center mb-3">
    <div class="col col-md-8">
      <div class="card mb-3">
        <div class="card-body">
          <p id="question-text"></p>
          <form id="question-form">
            <ul class="list-group" id="choices-list"></ul>
            <button type="button" id="check-btn" class="btn btn-success mt-2">Check Answer</button>
          </form>
          <div id="result" class="mt-3"></div>
          <div id="explanation" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="row justify-content-center mb-3 mt-3">
    <div class="col col-md-8 d-flex justify-content-between mt-4">
      <button id="prev-btn" class="btn btn-outline-secondary">Previous</button>
      <button id="next-btn" class="btn btn-outline-primary">Next</button>
      <button id="finish-btn" class="btn btn-outline-danger d-none">Finish</button>
    </div>

  </div>
</div>
<div id="results-container" class="container-lg py-4 d-none">
  <div class="row justify-content-center">
    <div class="col col-md-8">
      <h2 class="mb-4 text-primary fw-semibold">Your Results</h2>
      <div id="score-summary" class="mb-4"></div>
      <ul id="answers-list" class="list-group"></ul>
      <a href="{% url 'categories' %}" class="btn btn-primary mt-4">Back to Categories</a>
    </div>
  </div>
</div>
<script>
 function isMobile() {
  // Detecta apenas smartphones, não tablets
  return /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
    && !/iPad|Tablet|PlayBook|Silk|Kindle|Nexus 7|Nexus 10|KFAPWI/i.test(navigator.userAgent);
}

  const mobile = isMobile();

  // Dados vindos do backend
  const questions = JSON.parse('{{ questions_json|escapejs }}');
  let current = 0;
  let selected = [];

  function renderQuestion(idx) {
    const q = questions[idx];
    document.getElementById('question-text').textContent = q.question;
    document.getElementById('explanation').innerHTML = '';
    const ul = document.getElementById('choices-list');
    ul.innerHTML = '';
    selected = answersState[idx].selected ? [...answersState[idx].selected] : [];
    document.getElementById('result').innerHTML = '';

    // Mostra ou esconde o botão conforme o dispositivo
    document.getElementById('check-btn').style.display = mobile ? 'none' : 'inline-block';
    document.getElementById('category-title').style.display = mobile ? 'none' : 'inline-block';
    updateNavButtons();

    q.choices.forEach((c, i) => {
      const li = document.createElement('li');
      li.className = 'list-group-item rounded p-2 mb-2';
      li.style.cursor = 'pointer';
      li.textContent = c.text;
      if (selected.includes(c.id)) {
        li.classList.add('selected');
      }
      li.onclick = () => {
        if (answersState[idx].checked) return; // Prevent selection after checking
        if (q.multiple) {
          if (selected.includes(c.id)) {
            selected = selected.filter(id => id !== c.id);
            li.classList.remove('selected');
          } else {
            selected.push(c.id);
            li.classList.add('selected');
          }
        } else {
          selected = [c.id];
          Array.from(ul.children).forEach(child => child.classList.remove('selected'));
          li.classList.add('selected');
        }
        answersState[idx].selected = [...selected];
        answersState[idx].checked = false;
        answersState[idx].isCorrect = null;
        answersState[idx].explanationShown = false;
        document.getElementById('result').innerHTML = '';
        document.getElementById('explanation').innerHTML = '';

        // Se for mobile, checa automaticamente
        if (mobile) {
          checkAnswer();
        }

      };
      ul.appendChild(li);
    });

    // Restore checked state and feedback if already checked
    if (answersState[idx].checked) {     
      applyFeedback(ul, q, selected);      
      if (answersState[idx].explanationShown && q.explanation) {
        document.getElementById('explanation').innerHTML =
          `<div class="alert alert-info"><strong>Explanation:</strong> ${q.explanation}</div>`;
      }
    }

    // Botões
    document.getElementById('prev-btn').disabled = idx === 0;
    document.getElementById('next-btn').classList.toggle('d-none', idx === questions.length - 1);
    document.getElementById('finish-btn').classList.toggle('d-none', idx !== questions.length - 1);
  }

  document.getElementById('check-btn').onclick = function() {
    const q = questions[current];
    const ul = document.getElementById('choices-list');
    let correctIds = q.choices.filter(c => c.is_correct).map(c => c.id);
    let isCorrect = selected.length === correctIds.length && selected.every(id => correctIds.includes(id));    
    applyFeedback(ul, q, selected);

    document.getElementById('explanation').innerHTML = q.explanation
      ? `<div class="alert alert-info"><strong>Explanation:</strong> ${q.explanation}</div>`
      : '';

    // Save state
    answersState[current] = {
      selected: [...selected],
      checked: true,
      isCorrect: isCorrect,
      explanationShown: true
    };
  };

  function checkAnswer() {
    const q = questions[current];
    const ul = document.getElementById('choices-list');
    let correctIds = q.choices.filter(c => c.is_correct).map(c => c.id);
    let isCorrect = selected.length === correctIds.length && selected.every(id => correctIds.includes(id));
    applyFeedback(ul, q, selected);
    document.getElementById('explanation').innerHTML = q.explanation
      ? `<div class="alert alert-info"><strong>Explanation:</strong> ${q.explanation}</div>`
      : '';

    // Save state
    answersState[current] = {
      selected: [...selected],
      checked: true,
      isCorrect: isCorrect,
      explanationShown: true
    };
  }

  document.getElementById('next-btn').onclick = function() {
    if (current < questions.length - 1) {
      current++;
      renderQuestion(current);
    }
  };

  document.getElementById('prev-btn').onclick = function() {
    if (current > 0) {
      current--;
      renderQuestion(current);
    }
  };

  document.getElementById('finish-btn').onclick = function() {
    showResults();
  };

  let answersState = questions.map(() => ({
    selected: [],
    checked: false,
    isCorrect: null,
    explanationShown: false
  }));

  function applyFeedback(ul, q, selected) {
    Array.from(ul.children).forEach((li, i) => {
      const c = q.choices[i];
      li.classList.remove('bg-success', 'bg-danger', 'text-white', 'selected');
      // Remove old icon if exists
      const oldIcon = li.querySelector('.result-icon');
      if (oldIcon) li.removeChild(oldIcon);
      let icon = document.createElement('i');
      icon.className = 'result-icon ms-2 bi float-end fs-5';
      if (c.is_correct) {
        li.classList.add('bg-success', 'text-white');
        icon.classList.add('bi-check-circle-fill', 'text-white');
        li.appendChild(icon);
      } else if (selected.includes(c.id) && !c.is_correct) {
        li.classList.add('bg-danger', 'text-white');
        icon.classList.add('bi-x-circle-fill', 'text-white');
      li.appendChild(icon);
      }
    });
  }
  function updateNavButtons() {
      // Troca o estilo dos botões para links no mobile
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const finishBtn = document.getElementById('finish-btn');
      if (mobile) {
        prevBtn.className = 'btn btn-link';
        nextBtn.className = 'btn btn-link';
        finishBtn.className = 'btn btn-link d-none';
      } else {
        prevBtn.className = 'btn btn-outline-secondary';
        nextBtn.className = 'btn btn-outline-primary';
        finishBtn.className = 'btn btn-outline-danger d-none';
      }
    }


function showResults() {
  // Esconde o quiz
  document.querySelector('.container-lg.py-4').classList.add('d-none');
  document.getElementById('results-container').classList.remove('d-none');

  // Calcula o score
  let correctCount = answersState.filter(a => a.isCorrect).length;
  let percent = Math.round((correctCount / questions.length) * 100);

  document.getElementById('score-summary').innerHTML =
    `<h4>Score: ${correctCount} / ${questions.length} (${percent}%)</h4>`;

  // Lista de respostas
  const ul = document.getElementById('answers-list');
  ul.innerHTML = '';
  questions.forEach((q, idx) => {
    const user = answersState[idx];
    const li = document.createElement('li');
    li.className = 'list-group-item mb-2';
    let userChoices = q.choices.filter(c => user.selected.includes(c.id)).map(c => c.text).join(', ') || '<em>No answer</em>';
    let correctChoices = q.choices.filter(c => c.is_correct).map(c => c.text).join(', ');
    li.innerHTML = `
      <div><strong>Q${idx+1}:</strong> ${q.question}</div>
      <div><strong>Your answer:</strong> ${userChoices}</div>
      <div><strong>Correct answer:</strong> ${correctChoices}</div>
      ${user.isCorrect ? '<span class="badge bg-success">Correct</span>' : '<span class="badge bg-danger">Incorrect</span>'}
     
      ${q.explanation ? `<div class="explanation"><strong>Explanation:</strong> ${q.explanation}</div>` : ''}
    `;
    ul.appendChild(li);
  });
}



  // Inicialização
  renderQuestion(current);
</script>

<style>
.list-group-item.selected {
  background: #0d6efd !important;
  color: #fff !important;
}


</style>
{% endblock %}

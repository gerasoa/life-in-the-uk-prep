{% extends "base.html" %}
{% load static %}
{% block content %}


<div class="container">
  <div class="row">
    <div class="col">
      <p id="category-title">{{ category.name }}</p>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <div class="card mb-3">
        <div class="card-body">
          <p id="question-text"></p>
          <form id="question-form">
            <ul class="list-group" id="choices-list"></ul>
            <button type="button" id="check-btn" class="btn btn-success mt-2">Check Answer</button>
          </form>
          <div id="result" class="mt-3"></div>
          <div id="explanation" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-3">
    <div class="col d-flex justify-content-between align-items-center">
      <button id="prev-btn" class="btn btn-secondary" type="button">Previous</button>
      <button id="next-btn" class="btn btn-primary" type="button">Next</button>
      <button id="finish-btn" class="btn btn-danger d-none" type="button">Finish</button>
    </div>
  </div>
</div>

<script>
 function isMobile() {
  // Detecta apenas smartphones, não tablets
  return /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
    && !/iPad|Tablet|PlayBook|Silk|Kindle|Nexus 7|Nexus 10|KFAPWI/i.test(navigator.userAgent);
}

  const mobile = isMobile();

  // Dados vindos do backend
  const questions = JSON.parse('{{ questions_json|escapejs }}');
  let current = 0;
  let selected = [];

  function renderQuestion(idx) {
    const q = questions[idx];
    document.getElementById('question-text').textContent = q.question;
    document.getElementById('explanation').innerHTML = '';
    const ul = document.getElementById('choices-list');
    ul.innerHTML = '';
    selected = answersState[idx].selected ? [...answersState[idx].selected] : [];
    document.getElementById('result').innerHTML = '';

    // Mostra ou esconde o botão conforme o dispositivo
    document.getElementById('check-btn').style.display = mobile ? 'none' : 'inline-block';
    document.getElementById('category-title').style.display = mobile ? 'none' : 'inline-block';
    updateNavButtons();

    q.choices.forEach((c, i) => {
      const li = document.createElement('li');
      li.className = 'list-group-item rounded p-2 mb-2';
      li.style.cursor = 'pointer';
      li.textContent = c.text;
      if (selected.includes(c.id)) {
        li.classList.add('selected');
      }
      li.onclick = () => {
        if (answersState[idx].checked) return; // Prevent selection after checking
        if (q.multiple) {
          if (selected.includes(c.id)) {
            selected = selected.filter(id => id !== c.id);
            li.classList.remove('selected');
          } else {
            selected.push(c.id);
            li.classList.add('selected');
          }
        } else {
          selected = [c.id];
          Array.from(ul.children).forEach(child => child.classList.remove('selected'));
          li.classList.add('selected');
        }
        answersState[idx].selected = [...selected];
        answersState[idx].checked = false;
        answersState[idx].isCorrect = null;
        answersState[idx].explanationShown = false;
        document.getElementById('result').innerHTML = '';
        document.getElementById('explanation').innerHTML = '';

        // Se for mobile, checa automaticamente
        if (mobile) {
          checkAnswer();
        }

      };
      ul.appendChild(li);
    });

    // Restore checked state and feedback if already checked
    if (answersState[idx].checked) {
      // let correctIds = q.choices.filter(c => c.is_correct).map(c => c.id);
      // Array.from(ul.children).forEach((li, i) => {
      //   const c = q.choices[i];
      //   li.classList.remove('bg-success', 'bg-danger', 'text-white', 'selected');
      //   if (c.is_correct) {
      //     li.classList.add('bg-success', 'text-white');
      //   } else if (selected.includes(c.id) && !c.is_correct) {
      //     li.classList.add('bg-danger', 'text-white');
      //   }
      // });
      applyFeedback(ul, q, selected);
      // document.getElementById('result').innerHTML = answersState[idx].isCorrect
      //   ? '<div class="alert alert-success">✅ Correct!</div>'
      //   : '<div class="alert alert-danger">❌ Incorrect</div>';
      if (answersState[idx].explanationShown && q.explanation) {
        document.getElementById('explanation').innerHTML =
          `<div class="alert alert-info"><strong>Explanation:</strong> ${q.explanation}</div>`;
      }
    }

    // Botões
    document.getElementById('prev-btn').disabled = idx === 0;
    document.getElementById('next-btn').classList.toggle('d-none', idx === questions.length - 1);
    document.getElementById('finish-btn').classList.toggle('d-none', idx !== questions.length - 1);
  }

  document.getElementById('check-btn').onclick = function() {
    const q = questions[current];
    const ul = document.getElementById('choices-list');
    let correctIds = q.choices.filter(c => c.is_correct).map(c => c.id);
    let isCorrect = selected.length === correctIds.length && selected.every(id => correctIds.includes(id));
    // Feedback visual: only correct in green, wrong selected in red
    // Array.from(ul.children).forEach((li, i) => {
    //   const c = q.choices[i];
    //   li.classList.remove('bg-success', 'bg-danger', 'text-white', 'selected');
    //   if (c.is_correct) {
    //     li.classList.add('bg-success', 'text-white');
    //   } else if (selected.includes(c.id) && !c.is_correct) {
    //     li.classList.add('bg-danger', 'text-white');
    //   }
    // });
    applyFeedback(ul, q, selected);
    // document.getElementById('result').innerHTML = isCorrect
    //   ? '<div class="alert alert-success">✅ Correct!</div>'
    //   : '<div class="alert alert-danger">❌ Incorrect</div>';

    document.getElementById('explanation').innerHTML = q.explanation
      ? `<div class="alert alert-info"><strong>Explanation:</strong> ${q.explanation}</div>`
      : '';

    // Save state
    answersState[current] = {
      selected: [...selected],
      checked: true,
      isCorrect: isCorrect,
      explanationShown: true
    };
  };

  function checkAnswer() {
    const q = questions[current];
    const ul = document.getElementById('choices-list');
    let correctIds = q.choices.filter(c => c.is_correct).map(c => c.id);
    let isCorrect = selected.length === correctIds.length && selected.every(id => correctIds.includes(id));
    applyFeedback(ul, q, selected);
    // document.getElementById('result').innerHTML = isCorrect
    //   ? '<div class="alert alert-success">✅ Correct!</div>'
    //   : '<div class="alert alert-danger">❌ Incorrect</div>';

    document.getElementById('explanation').innerHTML = q.explanation
      ? `<div class="alert alert-info"><strong>Explanation:</strong> ${q.explanation}</div>`
      : '';

    // Save state
    answersState[current] = {
      selected: [...selected],
      checked: true,
      isCorrect: isCorrect,
      explanationShown: true
    };
  }

  document.getElementById('next-btn').onclick = function() {
    if (current < questions.length - 1) {
      current++;
      renderQuestion(current);
    }
  };

  document.getElementById('prev-btn').onclick = function() {
    if (current > 0) {
      current--;
      renderQuestion(current);
    }
  };

  document.getElementById('finish-btn').onclick = function() {
    window.location.href = "{% url 'categories' %}";
  };

  let answersState = questions.map(() => ({
    selected: [],
    checked: false,
    isCorrect: null,
    explanationShown: false
  }));

  function applyFeedback(ul, q, selected) {
    Array.from(ul.children).forEach((li, i) => {
      const c = q.choices[i];
      li.classList.remove('bg-success', 'bg-danger', 'text-white', 'selected');
      // Remove old icon if exists
      const oldIcon = li.querySelector('.result-icon');
      if (oldIcon) li.removeChild(oldIcon);
      let icon = document.createElement('i');
      icon.className = 'result-icon ms-2 bi float-end fs-5';
      if (c.is_correct) {
        li.classList.add('bg-success', 'text-white');
        icon.classList.add('bi-check-circle-fill', 'text-white');
        li.appendChild(icon);
      } else if (selected.includes(c.id) && !c.is_correct) {
        li.classList.add('bg-danger', 'text-white');
        icon.classList.add('bi-x-circle-fill', 'text-white');
      li.appendChild(icon);
      }
    });
  }
  function updateNavButtons() {
      // Troca o estilo dos botões para links no mobile
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      const finishBtn = document.getElementById('finish-btn');
      if (mobile) {
        prevBtn.className = 'btn btn-link';
        nextBtn.className = 'btn btn-link';
        finishBtn.className = 'btn btn-link d-none';
      } else {
        prevBtn.className = 'btn btn-secondary';
        nextBtn.className = 'btn btn-primary';
        finishBtn.className = 'btn btn-danger d-none';
      }
    }

  // Inicialização
  renderQuestion(current);
</script>

<style>
.list-group-item.selected {
  background: #0d6efd !important;
  color: #fff !important;
}
</style>
{% endblock %}

{% extends "base.html" %}
{% load static %}
{% block content %}


<div class="container">
  <div class="row">
    <div class="col">
      <h2 id="category-title">{{ category.name }}</h2>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <div class="card mb-3">
        <div class="card-body">
          <h5 id="question-text"></h5>
          <form id="question-form">
            <ul class="list-group" id="choices-list"></ul>
            <button type="button" id="check-btn" class="btn btn-success mt-2">Check Answer</button>
          </form>
          <div id="result" class="mt-3"></div>
          <div id="explanation" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="row mt-3">
    <div class="col d-flex gap-2">
      <button id="prev-btn" class="btn btn-secondary" type="button">Previous</button>
      <button id="next-btn" class="btn btn-primary" type="button">Next</button>
      <button id="finish-btn" class="btn btn-danger d-none" type="button">Finish</button>
    </div>
  </div>
</div>

<script>
  // Dados vindos do backend
  const questions = JSON.parse('{{ questions_json|escapejs }}');
  let current = 0;
  let selected = [];

  function renderQuestion(idx) {
    const q = questions[idx];
    document.getElementById('question-text').textContent = q.question;
    document.getElementById('explanation').innerHTML = '';
    const ul = document.getElementById('choices-list');
    ul.innerHTML = '';
    selected = [];
    document.getElementById('result').innerHTML = '';
    q.choices.forEach((c, i) => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.style.cursor = 'pointer';
      li.textContent = c.text;
      li.onclick = () => {
        if (q.multiple) {
          if (selected.includes(c.id)) {
            selected = selected.filter(id => id !== c.id);
            li.classList.remove('selected');
          } else {
            selected.push(c.id);
            li.classList.add('selected');
          }
        } else {
          selected = [c.id];
          Array.from(ul.children).forEach(child => child.classList.remove('selected'));
          li.classList.add('selected');
        }
      };
      ul.appendChild(li);
    });


    // Restore checked state and feedback if already checked
    if (answersState[idx].checked) {
      // Show feedback colors
      let correctIds = q.choices.filter(c => c.is_correct).map(c => c.id);
      Array.from(ul.children).forEach((li, i) => {
        const c = q.choices[i];
        li.classList.remove('bg-success', 'bg-danger', 'text-white');
        if (c.is_correct) {
          li.classList.add('bg-success', 'text-white');
        } else if (selected.includes(c.id)) {
          li.classList.add('bg-danger', 'text-white');
        }
      });
      document.getElementById('result').innerHTML = answersState[idx].isCorrect
        ? '<div class="alert alert-success">✅ Correct!</div>'
        : '<div class="alert alert-danger">❌ Incorrect</div>';
      if (answersState[idx].explanationShown && q.explanation) {
        document.getElementById('explanation').innerHTML =
          `<div class="alert alert-info"><strong>Explanation:</strong> ${q.explanation}</div>`;
      }
    }


    // Botões
    document.getElementById('prev-btn').disabled = idx === 0;
    document.getElementById('next-btn').classList.toggle('d-none', idx === questions.length - 1);
    document.getElementById('finish-btn').classList.toggle('d-none', idx !== questions.length - 1);
  }

  document.getElementById('check-btn').onclick = function() {
    const q = questions[current];
    const ul = document.getElementById('choices-list');
    let correctIds = q.choices.filter(c => c.is_correct).map(c => c.id);
    let isCorrect = selected.length === correctIds.length && selected.every(id => correctIds.includes(id));
    // Feedback visual
    Array.from(ul.children).forEach((li, i) => {
      const c = q.choices[i];
      li.classList.remove('bg-success', 'bg-danger', 'text-white');
      if (c.is_correct) {
        li.classList.add('bg-success', 'text-white');
      } else if (selected.includes(c.id)) {
        li.classList.add('bg-danger', 'text-white');
      }
    });
    document.getElementById('result').innerHTML = isCorrect
      ? '<div class="alert alert-success">✅ Correct!</div>'
      : '<div class="alert alert-danger">❌ Incorrect</div>';

    document.getElementById('explanation').innerHTML = q.explanation
      ? `<div class="alert alert-info"><strong>Explanation:</strong> ${q.explanation}</div>`
      : '';

    // Save state
    answersState[current] = {
      selected: [...selected],
      checked: true,
      isCorrect: isCorrect,
      explanationShown: true
    };
  };

  document.getElementById('next-btn').onclick = function() {
    if (current < questions.length - 1) {
      current++;
      renderQuestion(current);
    }
  };

  document.getElementById('prev-btn').onclick = function() {
    if (current > 0) {
      current--;
      renderQuestion(current);
    }
  };

  document.getElementById('finish-btn').onclick = function() {
    window.location.href = "{% url 'categories' %}";
  };

  let answersState = questions.map(() => ({
    selected: [],
    checked: false,
    isCorrect: null,
    explanationShown: false
  }));

  // Inicialização
  renderQuestion(current);
</script>

<style>
.list-group-item.selected {
  background: #0d6efd !important;
  color: #fff !important;
}
</style>
{% endblock %}
